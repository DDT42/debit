<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Débit du Lignon du Forez – Boën</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 16px;
}

.container {
  max-width: 820px;
  margin: auto;
  background: #ffffff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

h1 {
  font-size: 1.3em;
  margin-bottom: 8px;
}

#debit {
  font-size: 2.6em;
  font-weight: bold;
  margin: 10px 0;
}

#date {
  color: #555;
  margin-bottom: 14px;
}

canvas {
  width: 100% !important;
  height: 320px !important;
}

.footer {
  margin-top: 14px;
  font-size: 0.85em;
  color: #666;
}
</style>
</head>

<body>

<div class="container">

<h1>Débit du Lignon du Forez à Boën</h1>

<div id="debit">Chargement…</div>
<div id="date"></div>

<canvas id="graph"></canvas>

<div class="footer">
Source : données hydrométriques publiques (Hub’Eau)
</div>

</div>

<script>
// ===============================
// PARAMÈTRES STATION
// ===============================
const CODE_STATION = "K0753210";
const NB_JOURS = 7;

// Seuils (m³/s)
const DEBIT_ETIAGE = 0.658;   // 658 l/s
const DEBIT_HORS_ETIAGE = 4.27;

// Date début J-7
const dateDebut = new Date(
  Date.now() - NB_JOURS * 24 * 3600 * 1000
).toISOString();

// API Hub’Eau
const URL =
  "https://hubeau.eaufrance.fr/api/v2/hydrometrie/observations_tr" +
  "?code_entite=" + CODE_STATION +
  "&grandeur_hydro=Q" +
  "&date_debut_obs=" + dateDebut +
  "&sort=ASC" +
  "&size=1000";

// ===============================
// APPEL API
// ===============================
fetch(URL)
  .then(r => {
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  })
  .then(json => {

    if (!json.data || json.data.length === 0) {
      document.getElementById("debit").innerText =
        "Pas de données disponibles";
      return;
    }

    const data = json.data;

    // ---- Débit actuel (AFFICHAGE CONDITIONNEL)
    const last = data[data.length - 1];
    const q_ls = Number(last.resultat_obs); // l/s
    const q_m3s = q_ls / 1000;

    let affichage;
    if (q_m3s >= 1) {
      affichage =
        q_m3s.toLocaleString("fr-FR", {
          minimumFractionDigits: 3,
          maximumFractionDigits: 3
        }) + " m³/s";
    } else {
      affichage =
        Math.round(q_ls).toLocaleString("fr-FR") + " l/s";
    }

    document.getElementById("debit").innerText = affichage;
    document.getElementById("date").innerText =
      "Mesure du " + new Date(last.date_obs).toLocaleString("fr-FR");

    // ---- Données graphe
    const labels = data.map(d =>
      new Date(d.date_obs).toLocaleString("fr-FR", {
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit"
      })
    );

    const serie = data.map(d => Number(d.resultat_obs) / 1000);

    // ---- Graphe
    new Chart(document.getElementById("graph"), {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Débit observé",
            data: serie,
            borderColor: "#007bff",
            backgroundColor: "rgba(0,123,255,0.15)",
            borderWidth: 2,
            tension: 0.35,
            fill: true,
            pointRadius: 0
          },
          {
            label: "Débit d'étiage (658 l/s)",
            data: labels.map(() => DEBIT_ETIAGE),
            borderColor: "#dc3545",
            borderDash: [6,6],
            borderWidth: 2,
            pointRadius: 0
          },
          {
            label: "Débit hors étiage (4,27 m³/s)",
            data: labels.map(() => DEBIT_HORS_ETIAGE),
            borderColor: "#28a745",
            borderDash: [6,6],
            borderWidth: 2,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: ctx =>
                Math.round(ctx.parsed.y) + " m³/s"
            }
          }
        },
        scales: {
          y: {
            title: {
              display: true,
              text: "Débit (m³/s)"
            },
            ticks: {
              callback: v =>
                v.toLocaleString("fr-FR", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                }) + " m³/s"
            }
          },
          x: {
            ticks: { maxTicksLimit: 6 },
            grid: { display: false }
          }
        }
      }
    });
  })
  .catch(err => {
    console.error(err);
    document.getElementById("debit").innerText =
      "Erreur de chargement des données";
  });
</script>

</body>
</html>
