<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Débit de l’Aix – Saint-Germain-Laval</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 16px;
}
.container {
  max-width: 820px;
  margin: auto;
  background: #ffffff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
h1 {
  font-size: 1.3em;
  margin-bottom: 8px;
}
#debit {
  font-size: 2.6em;
  font-weight: bold;
  margin: 10px 0;
}
#date {
  color: #555;
  margin-bottom: 14px;
}
canvas {
  width: 100% !important;
  height: 320px !important;
}
.footer {
  margin-top: 14px;
  font-size: 0.85em;
  color: #666;
}
</style>
</head>

<body>
<div class="container">

<h1>Débit de l’Aix à Saint-Germain-Laval</h1>

<div id="debit">Chargement…</div>
<div id="date"></div>

<canvas id="graph"></canvas>

<div class="footer">
Source : données hydrométriques publiques (Hub’Eau)
</div>

</div>

<script>
// ===============================
// PARAMÈTRES
// ===============================
const CODE_SITE = "K0813020";
const NB_JOURS = 7;

// Seuils (m³/s)
const DEBIT_ETIAGE = 0.3047;
const DEBIT_HORS_ETIAGE = 1.55;

// Dates
const dateDebut = new Date(
  Date.now() - NB_JOURS * 24 * 3600 * 1000
).toISOString();

// ===============================
// URL API
// ===============================

// 1️⃣ DERNIÈRE VALEUR DISPONIBLE (COMME HYDROPORTAIL)
const URL_LIVE =
  "https://hubeau.eaufrance.fr/api/v2/hydrometrie/observations_tr" +
  "?code_entite=" + CODE_SITE +
  "&grandeur_hydro=Q" +
  "&sort=DESC" +
  "&size=1" +
  "&_=" + Date.now();

// 2️⃣ HISTORIQUE POUR LE GRAPHE
const URL_GRAPH =
  "https://hubeau.eaufrance.fr/api/v2/hydrometrie/observations_tr" +
  "?code_entite=" + CODE_SITE +
  "&grandeur_hydro=Q" +
  "&date_debut_obs=" + dateDebut +
  "&sort=ASC" +
  "&size=1000" +
  "&_=" + Date.now();

// ===============================
// APPEL 1 : VALEUR ACTUELLE
// ===============================
fetch(URL_LIVE)
  .then(r => r.json())
  .then(json => {
    const obs = json.data[0];
    const q_ls = Number(obs.resultat_obs);
    const q_m3s = q_ls / 1000;

    let affichage;
    if (q_m3s >= 1) {
      affichage =
        q_m3s.toLocaleString("fr-FR", {
          minimumFractionDigits: 3,
          maximumFractionDigits: 3
        }) + " m³/s";
    } else {
      affichage =
        Math.round(q_ls).toLocaleString("fr-FR") + " l/s";
    }

    document.getElementById("debit").innerText = affichage;
    document.getElementById("date").innerText =
      "Dernière mesure : " +
      new Date(obs.date_obs).toLocaleString("fr-FR");
  });

// ===============================
// APPEL 2 : GRAPHE
// ===============================
fetch(URL_GRAPH)
  .then(r => r.json())
  .then(json => {

    if (!json.data || json.data.length === 0) return;

    const data = json.data;

    const labels = data.map(d =>
      new Date(d.date_obs).toLocaleString("fr-FR", {
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit"
      })
    );

    const serie = data.map(d => Number(d.resultat_obs) / 1000);

    new Chart(document.getElementById("graph"), {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Débit observé",
            data: serie,
            borderColor: "#007bff",
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 0
          },
          {
            label: "Débit d’étiage (304,7 l/s)",
            data: labels.map(() => DEBIT_ETIAGE),
            borderColor: "#dc3545",
            borderDash: [6,6],
            borderWidth: 2,
            pointRadius: 0
          },
          {
            label: "Débit hors étiage (1,55 m³/s)",
            data: labels.map(() => DEBIT_HORS_ETIAGE),
            borderColor: "#28a745",
            borderDash: [6,6],
            borderWidth: 2,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: ctx =>
                Math.round(ctx.parsed.y) + " m³/s"
            }
          }
        },
        scales: {
          y: {
            title: {
              display: true,
              text: "Débit"
            },
            ticks: {
              callback: v =>
                v.toLocaleString("fr-FR", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                }) + " m³/s"
            }
          },
          x: {
            ticks: { maxTicksLimit: 6 },
            grid: { display: false }
          }
        }
      }
    });
  });

// ===============================
// RAFRAÎCHISSEMENT AUTO (10 min)
// ===============================
setInterval(() => {
  location.reload();
}, 10 * 60 * 1000);

</script>

</body>
</html>
