<script>
// ===============================
// PARAMÃˆTRES
// ===============================
const CODE_SITE = "K0813020";
const NB_JOURS = 7;

// Seuils (mÂ³/s)
const DEBIT_ETIAGE = 0.3047;
const DEBIT_HORS_ETIAGE = 1.55;

// Limite temporelle graphe
const now = Date.now();
const limiteTemps = now - NB_JOURS * 24 * 3600 * 1000;

// ===============================
// URL API
// ===============================

// DerniÃ¨re valeur DISPONIBLE (fiable)
const URL_LIVE =
  "https://hubeau.eaufrance.fr/api/v2/hydrometrie/observations_tr" +
  "?code_entite=" + CODE_SITE +
  "&grandeur_hydro=Q" +
  "&sort=DESC" +
  "&size=1" +
  "&_=" + Date.now();

// Historique BRUT (sans filtre date)
const URL_GRAPH =
  "https://hubeau.eaufrance.fr/api/v2/hydrometrie/observations_tr" +
  "?code_entite=" + CODE_SITE +
  "&grandeur_hydro=Q" +
  "&sort=DESC" +
  "&size=1500" +
  "&_=" + Date.now();

// ===============================
// 1ï¸âƒ£ VALEUR INSTANTANÃ‰E
// ===============================
fetch(URL_LIVE)
  .then(r => r.json())
  .then(json => {
    const obs = json.data[0];
    const q_ls = Number(obs.resultat_obs);
    const q_m3s = q_ls / 1000;

    let affichage;
    if (q_m3s >= 1) {
      affichage =
        q_m3s.toLocaleString("fr-FR", {
          minimumFractionDigits: 3,
          maximumFractionDigits: 3
        }) + " mÂ³/s";
    } else {
      affichage =
        Math.round(q_ls).toLocaleString("fr-FR") + " l/s";
    }

    document.getElementById("debit").innerText = affichage;
    document.getElementById("date").innerText =
      "DerniÃ¨re mesure : " +
      new Date(obs.date_obs).toLocaleString("fr-FR");
  });

// ===============================
// 2ï¸âƒ£ GRAPHE (RECONSTRUCTION SÃ‰RIE)
// ===============================
fetch(URL_GRAPH)
  .then(r => r.json())
  .then(json => {

    if (!json.data || json.data.length === 0) return;

    // ðŸ”¹ filtrage cÃ´tÃ© JS (7 jours glissants)
    const data = json.data
      .filter(d => new Date(d.date_obs).getTime() >= limiteTemps)
      .sort((a, b) => new Date(a.date_obs) - new Date(b.date_obs));

    if (data.length === 0) return;

    const labels = data.map(d =>
      new Date(d.date_obs).toLocaleString("fr-FR", {
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit"
      })
    );

    const serie = data.map(d => Number(d.resultat_obs) / 1000);

    new Chart(document.getElementById("graph"), {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "DÃ©bit observÃ©",
            data: serie,
            borderColor: "#007bff",
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 0
          },
          {
            label: "DÃ©bit dâ€™Ã©tiage (304,7 l/s)",
            data: labels.map(() => DEBIT_ETIAGE),
            borderColor: "#dc3545",
            borderDash: [6,6],
            borderWidth: 2,
            pointRadius: 0
          },
          {
            label: "DÃ©bit hors Ã©tiage (1,55 mÂ³/s)",
            data: labels.map(() => DEBIT_HORS_ETIAGE),
            borderColor: "#28a745",
            borderDash: [6,6],
            borderWidth: 2,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: ctx =>
                Math.round(ctx.parsed.y) + " mÂ³/s"
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: v =>
                v.toLocaleString("fr-FR", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                }) + " mÂ³/s"
            }
          },
          x: {
            ticks: { maxTicksLimit: 6 },
            grid: { display: false }
          }
        }
      }
    });
  });

// ===============================
// RAFRAÃŽCHISSEMENT AUTO
// ===============================
setInterval(() => location.reload(), 10 * 60 * 1000);
</script>
