<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Débit de l’Aix – Saint-Germain-Laval</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 16px;
}

.container {
  max-width: 820px;
  margin: auto;
  background: #ffffff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

h1 {
  font-size: 1.3em;
  margin-bottom: 8px;
}

#debit {
  font-size: 2.6em;
  font-weight: bold;
  margin: 10px 0;
}

#date {
  color: #555;
  margin-bottom: 14px;
}

canvas {
  width: 100% !important;
  height: 320px !important;
}

.footer {
  margin-top: 14px;
  font-size: 0.85em;
  color: #666;
}
</style>
</head>

<body>

<div class="container">

<h1>Débit de l’Aix à Saint-Germain-Laval</h1>

<div id="debit">Chargement…</div>
<div id="date"></div>

<canvas id="graph"></canvas>

<div class="footer">
Source : données hydrométriques publiques (Hub’Eau)
</div>

</div>

<script>
// ======================================
// PARAMÈTRES
// ======================================
const CODE_STATION = "K0813020";
const NB_JOURS = 7;

// Seuils réglementaires (m³/s)
const DEBIT_ETIAGE = 0.3047;       // 304,7 l/s
const DEBIT_HIVER_HORS_ETIAGE = 1.55; // 1,55 m³/s

// Date début J-7
const dateDebut = new Date(
  Date.now() - NB_JOURS * 24 * 3600 * 1000
).toISOString();

// API Hub’Eau v2
const URL =
  "https://hubeau.eaufrance.fr/api/v2/hydrometrie/observations_tr" +
  "?code_entite=" + CODE_STATION +
  "&grandeur_hydro=Q" +
  "&date_debut_obs=" + dateDebut;

// ======================================
// APPEL API
// ======================================
fetch(URL)
  .then(r => r.json())
  .then(json => {

    const data = json.data.reverse();

    // ======================================
    // DÉBIT ACTUEL
    // ======================================
    const last = data[data.length - 1];
    const q_ls = Number(last.resultat_obs); // l/s
    const q_m3s = q_ls / 1000;

    let affichageDebit;

    if (q_m3s >= 1) {
      affichageDebit =
        q_m3s.toLocaleString("fr-FR", {
          minimumFractionDigits: 3,
          maximumFractionDigits: 3
        }) + " m³/s";
    } else {
      affichageDebit =
        Math.round(q_ls).toLocaleString("fr-FR") + " l/s";
    }

    document.getElementById("debit").innerText = affichageDebit;
    document.getElementById("date").innerText =
      "Mesure du " + new Date(last.date_obs).toLocaleString("fr-FR");

    // ======================================
    // GRAPHE AVEC SEUILS
    // ======================================
    const labels = data.map(d =>
      new Date(d.date_obs).toLocaleString("fr-FR", {
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit"
      })
    );

    const debitSerie = data.map(d => Number(d.resultat_obs) / 1000);

    new Chart(document.getElementById("graph"), {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Débit observé (m³/s)",
            data: debitSerie,
            borderColor: "rgba(0, 123, 255, 1)",
            backgroundColor: "rgba(0, 123, 255, 0.12)",
            borderWidth: 2,
            tension: 0.35,
            fill: true,
            pointRadius: 0
          },
          {
            label: "Débit d’étiage (0,305 m³/s)",
            data: labels.map(() => DEBIT_ETIAGE),
            borderColor: "rgba(220, 53, 69, 1)", // rouge
            borderWidth: 2,
            borderDash: [6, 6],
            pointRadius: 0,
            fill: false
          },
          {
            label: "Débit hivernal hors étiage (1,55 m³/s)",
            data: labels.map(() => DEBIT_HIVER_HORS_ETIAGE),
            borderColor: "rgba(40, 167, 69, 1)", // vert
            borderWidth: 2,
            borderDash: [6, 6],
            pointRadius: 0,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom"
          },
          tooltip: {
            callbacks: {
              label: ctx =>
                ctx.parsed.y.toFixed(3) + " m³/s"
            }
          }
        },
        scales: {
          x: {
            ticks: { maxTicksLimit: 6 },
            grid: { display: false }
          },
          y: {
            title: {
              display: true,
              text: "Débit (m³/s)"
            },
            ticks: {
              callback: v => v.toFixed(3)
            }
          }
        }
      }
    });
  })
  .catch(() => {
    document.getElementById("debit").innerText =
      "Données indisponibles";
  });
</script>

</body>
</html>
